<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ†ã‚¹ãƒˆç”¨WebMéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆãƒ„ãƒ¼ãƒ«</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 10px 5px;
      cursor: pointer;
    }
    .recording {
      color: red;
      font-weight: bold;
    }
    .status {
      margin: 20px 0;
      padding: 10px;
      background: #f0f0f0;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>ãƒ†ã‚¹ãƒˆç”¨WebMéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆãƒ„ãƒ¼ãƒ«</h1>
  
  <div class="status" id="status">æº–å‚™å®Œäº†</div>
  
  <button id="startBtn" onclick="startRecording()">éŒ²éŸ³é–‹å§‹</button>
  <button id="stopBtn" onclick="stopRecording()" disabled>éŒ²éŸ³åœæ­¢</button>
  
  <div style="margin-top: 20px;">
    <label>
      éŒ²éŸ³æ™‚é–“ï¼ˆç§’ï¼‰:
      <input type="number" id="duration" value="5" min="1" max="30" style="width: 60px;">
    </label>
  </div>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    let timeoutId;

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };

        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const audioUrl = URL.createObjectURL(audioBlob);
          
          // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
          const a = document.createElement('a');
          a.href = audioUrl;
          a.download = 'test-audio.webm';
          a.click();
          
          // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          URL.revokeObjectURL(audioUrl);
          stream.getTracks().forEach(track => track.stop());
          
          document.getElementById('status').textContent = 
            `âœ… éŒ²éŸ³å®Œäº†ï¼test-audio.webm ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚`;
          document.getElementById('status').style.color = 'green';
        };

        mediaRecorder.start();
        document.getElementById('status').textContent = 'ğŸ”´ éŒ²éŸ³ä¸­...';
        document.getElementById('status').style.color = 'red';
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;

        // è‡ªå‹•åœæ­¢ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        const duration = parseInt(document.getElementById('duration').value) * 1000;
        timeoutId = setTimeout(() => {
          stopRecording();
        }, duration);

      } catch (error) {
        console.error('éŒ²éŸ³ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('status').textContent = 
          `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}\nãƒã‚¤ã‚¯ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚`;
        document.getElementById('status').style.color = 'red';
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        if (timeoutId) {
          clearTimeout(timeoutId);
        }
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
      }
    }
  </script>
</body>
</html>
